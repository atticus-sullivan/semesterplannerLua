\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{semesterplanner-lua}[2021/10/06 Semesterplanner package]

\RequirePackage{tikz}
\RequirePackage{pgfkeys}
\RequirePackage{xcolor}
\RequirePackage{fontawesome}

\definecolor{dodgerblue}{rgb}{0.12, 0.56, 1.0}
% Colors for the course types.
\definecolor{seminar}{rgb}{1.0, 0.8, 0.0}
\definecolor{lecture}{rgb}{0.2, 0.7, 1.0}
\definecolor{tutorial}{rgb}{0.0, 0.8, 0.0}
\definecolor{meeting}{rgb}{0.8, 0.0, 0.0}
\definecolor{officehour}{rgb}{0.0, 0.4, 0.6}

% command to put circle arround fontawesome symbol so that they keep being readable
\newcommand*{\encircle}[1]{
	\begin{minipage}[b][1em][c]{1.5em}
		\begin{tikzpicture}
			\node[fill,circle,inner sep=1pt, color = white] {#1};
		\end{tikzpicture}	
	\end{minipage}
}

\directlua{dofile("semesterplanner.lua")}

\newenvironment{timetable}[1][]{
	% setting the default each time once again
	\pgfkeys{
		/semesterplanner/.cd,
		% environment arguments
		days/.initial={Mon,Thue,Wend,Thur,Fri},
		days/.default={Mon,Thue,Wend,Thur,Fri},
		% set these times to the minutes to overwrite the default behaviour of setting the min/max time the start/end time of the timetable
		start time/.initial=,
		start time/.default=,
		end time/.initial=,
		end time/.default=,
		%
		width/.initial=\textwidth,
		width/.default=\textwidth,
		length/.initial=10, % measured in cm
		length/.default=10, % measured in cm
		%
		event/.cd,
		% event arguments
		content/.initial=,
		content/.default=,
		%
		time/.initial=,
		time/.default=,
		day/.initial=,
		day/.default=,
		% optional event arguments
		tikz/.initial=,
		tikz/.default=,
		scale width/.initial=1,
		scale width/.default=1,
		offset/.initial=0,
		offset/.default=0,
	}

	% Commands for symbols of priority
	\protected\def\pmandatory{\encircle{\textcolor{red}{\faWarning}}}
	\protected\def\phigh{\encircle{\textcolor{red}{\faFlag}}}
	\protected\def\pmid{\encircle{\textcolor{yellow}{\faFlag}}}
	\protected\def\plow{\encircle{\textcolor{green}{\faFlag}}}
	\protected\def\pnone{\encircle{\textcolor{gray}{\faTimesCircle}}}
	% Commands for online platforms.
	\protected\def\teams{\encircle{\textcolor{dodgerblue}{\faWindows}}}
	\protected\def\zoom{\encircle{\textcolor{dodgerblue}{\faCamera}}}
	\protected\def\youtube{\encircle{\textcolor{red}{\faYoutubePlay}}}
	% Command for "To be determined" and "To be Announced"
	\protected\def\tbd{\faQuestion}
	\protected\def\tba{\faBullhorn}
	% options as pgfkeys
	\pgfkeys{/pgf/number format=fixed, /semesterplanner/.cd, start time,end time, #1} % setting defaults here will affect this timetable
	\directlua{init("\pgfkeysvalueof{/semesterplanner/days}", "\pgfkeysvalueof{/semesterplanner/start time}", "\pgfkeysvalueof{/semesterplanner/end time}")}
	%
	\newcommand{\semesterplanner@event}[2][]{
		\pgfkeys{/semesterplanner/event/.cd,time,day,tikz,content,offset,scale width, ##1, content=##2}
		\directlua{
			addEvent{
				time="\pgfkeysvalueof{/semesterplanner/event/time}",
				day="\pgfkeysvalueof{/semesterplanner/event/day}",
				tikz=[[\pgfkeysvalueof{/semesterplanner/event/tikz}]],
				content=[[\pgfkeysvalueof{/semesterplanner/event/content}]],
				offset=\pgfkeysvalueof{/semesterplanner/event/offset},
				scale_width=\pgfkeysvalueof{/semesterplanner/event/scale width},
			}
		}
	}
	\def\semesterplanner@formattedEvent##1##2##3##4##5##6##7##8{ %##1=title, ##2=speaker, ##3=location, ##4=day, ##5=time, ##6=priority, ##7=event-code (tikz can eb set this way too but you must use append)
		\semesterplanner@event[time=##5, day=##4, tikz={fill=##8}, ##7]
		{
			\unexpanded{
				\textcolor{white}{
					\textbf{##1}\\[.2em]
					\raggedright{##2}\\[0.5em]\raggedright{##6}\raggedright{##3}
				}
			}
		}
	}
	%
	\def\lecture##1##2##3##4##5##6##7{ %##1=title, ##2=speaker, ##3=location, ##4=day, ##5=time, ##6=priority, ##7=event-code (tikz can eb set this way too but you must use append)
		\semesterplanner@formattedEvent{##1}{##2}{##3}{##4}{##5}{##6}{##7}{lecture}
	}
	\def\seminar##1##2##3##4##5##6##7{ %##1=title, ##2=speaker, ##3=location, ##4=day, ##5=time, ##6=priority, ##7=event-code (tikz can eb set this way too but you must use append)
		\semesterplanner@formattedEvent{##1}{##2}{##3}{##4}{##5}{##6}{##7}{seminar}
	}
	\def\tutorial##1##2##3##4##5##6##7{ %##1=title, ##2=speaker, ##3=location, ##4=day, ##5=time, ##6=priority, ##7=event-code (tikz can eb set this way too but you must use append)
		\semesterplanner@formattedEvent{##1}{##2}{##3}{##4}{##5}{##6}{##7}{tutorial}
	}
	\def\meeting##1##2##3##4##5##6##7{ %##1=title, ##2=speaker, ##3=location, ##4=day, ##5=time, ##6=priority, ##7=event-code (tikz can eb set this way too but you must use append)
		\semesterplanner@formattedEvent{##1}{##2}{##3}{##4}{##5}{##6}{##7}{meeting}
	}
	\def\officehour##1##2##3##4##5##6##7{ %##1=title, ##2=speaker, ##3=location, ##4=day, ##5=time, ##6=priority, ##7=event-code (tikz can eb set this way too but you must use append)
		\semesterplanner@formattedEvent{##1}{##2}{##3}{##4}{##5}{##6}{##7}{officehour}
	}
}{
	\directlua{draw([[\pgfkeysvalueof{/semesterplanner/length}]], [[\pgfkeysvalueof{/semesterplanner/width}]])}
}
